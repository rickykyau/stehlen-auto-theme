<script
  type="module"
  src="{{ 'cart-icon.js' | asset_url }}"
  fetchpriority="low"
></script>

<header-actions
  {{- block.shopify_attributes -}}
>
  <!-- My Vehicle Control (CARiD style) -->
  <div class="my-vehicle-header" id="my-vehicle-header">
    <button type="button" class="my-vehicle-btn" id="my-vehicle-btn" style="border: 1px solid rgba(255,255,255,0.7) !important; outline: none !important;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
        <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
        <path d="M5 17h-2v-6l2-5h9l4 5h1a2 2 0 0 1 2 2v4h-2"/>
        <path d="M9 17h6"/>
        <path d="M5 11h14"/>
      </svg>
      <span id="my-vehicle-text">SELECT YOUR VEHICLE</span>
      <span id="my-vehicle-change" style="display:none; color:#F39C12; font-weight:700; margin-left:6px; font-size:0.75rem;">CHANGE</span>
    </button>
    <script>
      /* Restore saved vehicle label */
      (function() {
        try {
          var sv = JSON.parse(localStorage.getItem('selectedVehicle'));
          if (sv && sv.year && sv.make && sv.model) {
            var label = sv.year + ' ' + sv.make + ' ' + sv.model;
            function apply() {
              var el = document.getElementById('my-vehicle-text');
              var ch = document.getElementById('my-vehicle-change');
              if (el && el.textContent !== label) el.textContent = label;
              if (ch) ch.style.display = 'inline';
            }
            apply();
            setTimeout(apply, 200);
            setTimeout(apply, 1000);
            setTimeout(apply, 3000);
          }
        } catch(e) {}
/* layout fix moved outside header-actions */
      })();
    </script>
  </div>

  {% if shop.customer_accounts_enabled %}
    {% render 'account-popover' %}
    {% render 'account-drawer' %}
  {% endif %}

  {% if settings.cart_type == 'drawer' and template.name != 'cart' %}
    {% render 'cart-drawer' %}
  {% else %}
    <a
      href="{{ routes.cart_url }}"
      class="header-actions__action action__cart"
      aria-label="{{ 'accessibility.cart' | t }}"
      aria-describedby="cart-bubble-text"
    >
      {% render 'cart-icon-component' %}
    </a>
  {% endif %}
</header-actions>

<script>
/* Remove stale scroll-lock on page load (fixes mobile scroll after navigation) */
(function(){
  document.documentElement.removeAttribute('scroll-lock');
  document.body.style.overflow = '';
})();

/* Fix header layout: logo compact left, search fills remaining space */
(function fixHeaderLayout() {
  function fix() {
    var cols = document.querySelector('.header__columns.spacing-style');
    if (cols) cols.style.cssText += ';display:grid!important;grid-template-columns:auto 1fr!important;gap:8px!important;';
    var leftCol = document.querySelector('.header__column--left');
    if (leftCol) leftCol.style.cssText += ';width:auto!important;min-width:0!important;flex-shrink:0!important;gap:4px!important;';
    var rightCol = document.querySelector('.header__column--right');
    if (rightCol) rightCol.style.cssText += ';display:flex!important;align-items:center!important;gap:12px!important;width:100%!important;justify-content:flex-start!important;';
    var searchBtn = document.querySelector('.header__column--right search-button');
    if (searchBtn) searchBtn.style.cssText += ';flex:1 1 0%!important;max-width:none!important;min-width:0!important;';
    /* Keep header-actions compact */
    var actions = document.querySelector('.header__column--right header-actions');
    if (actions) actions.style.cssText += ';flex-shrink:0!important;flex-grow:0!important;';
    var loc = document.querySelector('.header__column--right .dropdown-localization');
    if (loc) loc.style.cssText += ';flex-shrink:0!important;flex-grow:0!important;';
  }
  fix();
  setTimeout(fix, 100);
  setTimeout(fix, 500);
  setTimeout(fix, 2000);
})();
</script>

<!-- Vehicle Selector Modal — OUTSIDE header-actions to avoid theme style interference -->
<div class="mvd-overlay" id="mvd-overlay">
  <div class="mvd-modal" id="mvd-modal">
    <div id="mvd-close" role="button" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#666;font-size:2rem;cursor:pointer;line-height:1;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;z-index:10;"
    onmouseover="this.style.background='#f0f0f0';this.style.color='#333'"
    onmouseout="this.style.background='none';this.style.color='#666'">&times;</div>
    <h2 class="mvd-title">Select Your Vehicle</h2>
    <p class="mvd-subtitle">Provide vehicle details to confirm fitment</p>
    <div class="mvd-form-row">
      <div class="mvd-select-group">
        <label class="mvd-label" for="mvd-year">Year</label>
        <select id="mvd-year">
          <option value="">— Select Year —</option>
          {%- for y in (1990..2026) reversed -%}<option value="{{ y }}">{{ y }}</option>{%- endfor -%}
        </select>
      </div>
      <div class="mvd-select-group">
        <label class="mvd-label" for="mvd-make">Make</label>
        <select id="mvd-make" disabled><option value="">— Select Make —</option></select>
      </div>
      <div class="mvd-select-group">
        <label class="mvd-label" for="mvd-model">Model</label>
        <select id="mvd-model" disabled><option value="">— Select Model —</option></select>
      </div>
      <div id="mvd-go" role="button" style="background:#999;color:#fff;padding:14px 32px;border:none;border-radius:8px;font-size:1rem;font-weight:800;text-transform:uppercase;min-width:80px;height:48px;cursor:not-allowed;flex-shrink:0;align-self:flex-end;display:flex;align-items:center;justify-content:center;user-select:none;line-height:1;">GO</div>
    </div>
    <div id="mvd-current" style="display:none;text-align:center;margin-top:16px;padding-top:12px;border-top:1px solid #eee;">
      <span id="mvd-current-text" style="color:#F39C12;font-size:0.9rem;font-weight:600;"></span>
      <div id="mvd-clear-btn" role="button" style="display:inline-flex;align-items:center;gap:4px;margin-left:12px;padding:6px 14px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;color:#666;font-size:0.8rem;font-weight:600;cursor:pointer;"
      onmouseover="this.style.background='#fee2e2';this.style.color='#dc2626';this.style.borderColor='#fca5a5'"
      onmouseout="this.style.background='#f5f5f5';this.style.color='#666';this.style.borderColor='#ddd'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        Clear
      </div>
    </div>
  </div>
</div>

<script>
/* Vehicle data built dynamically from product titles */
var __stehlenProducts = [
  {%- paginate collections.all.products by 250 -%}
    {%- for product in collections.all.products -%}
      {{ product.title | json }}{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  {%- endpaginate -%}
];

/* Parse year ranges, makes, and models from product titles */
var __stehlenVehicleData = (function() {
  /* Auto-extract make + model from product titles
     Title format: "YYYY-YYYY Make Model Rest..." or "YYYY+ Make Model Rest..."
     Examples: "2003-2009 Toyota 4Runner Bull Guard"
               "2011-2023 Chrysler 300/300C Trailer Hitch"
               "1991-2002 Ford Escort/Mercury Tracer Class 1"  */

  var data = {};

  __stehlenProducts.forEach(function(title) {
    /* Extract year range */
    var yrMatch = title.match(/(\d{4})\s*[-–]\s*(\d{4})/);
    var yrPlusMatch = !yrMatch && title.match(/(\d{4})\+/);
    var startYear, endYear;
    if (yrMatch) { startYear = +yrMatch[1]; endYear = +yrMatch[2]; }
    else if (yrPlusMatch) { startYear = +yrPlusMatch[1]; endYear = 2026; }
    else { return; }

    /* Remove year portion to get "Make Model Rest..." */
    var rest = title.replace(/^\d{4}\s*[-–+]\s*\d{0,4}\s*/, '').trim();

    /* Known makes to look for (auto-expanded) */
    var makes = ['Ford','Chevy','Chevrolet','GMC','Dodge','Ram','Toyota','Honda','Nissan',
      'Jeep','Subaru','Mazda','Hyundai','Mercedes-Benz','Mercedes','Chrysler','Buick',
      'Saturn','Pontiac','Acura','Kia','Audi','BMW','Volkswagen','VW','Lincoln',
      'Mercury','Infiniti','Lexus','Mitsubishi','Volvo','Cadillac','Scion'];

    /* Normalize display names */
    var nameMap = {'Chevrolet':'Chevy','Mercedes':'Mercedes-Benz','VW':'Volkswagen'};

    /* Handle slash-separated makes: "Chevy/GMC", "Ford Escort/Mercury Tracer" */
    var segments = rest.split(/\s*\/\s*/);

    segments.forEach(function(seg) {
      var words = seg.trim().split(/\s+/);
      var foundMake = null;
      var modelStart = 0;

      /* Check first 1-2 words for make */
      for (var i = 0; i < Math.min(2, words.length); i++) {
        var candidate = words.slice(0, i+1).join(' ');
        for (var mi = 0; mi < makes.length; mi++) {
          if (candidate.toLowerCase() === makes[mi].toLowerCase()) {
            foundMake = nameMap[makes[mi]] || makes[mi];
            modelStart = i + 1;
            break;
          }
        }
        if (foundMake) break;
      }
      if (!foundMake) return;

      /* Model = next 1-3 words until we hit a product-type keyword */
      var stopWords = ['trailer','hitch','class','bull','guard','grille','side','step','nerf',
        'bar','tonneau','cover','chase','rack','sport','matte','black','stainless','led',
        'light','low','profile','hard','tri-fold','bed','universal','-','w/'];
      var modelWords = [];
      for (var j = modelStart; j < words.length && modelWords.length < 3; j++) {
        if (stopWords.indexOf(words[j].toLowerCase()) >= 0) break;
        /* Also stop at "C/K" style model qualifiers after we have something */
        modelWords.push(words[j]);
      }

      var model = modelWords.join(' ').replace(/[-,]$/, '') || 'Other';
      if (!data[foundMake]) data[foundMake] = {};
      if (!data[foundMake][model]) data[foundMake][model] = [];
      for (var y = startYear; y <= endYear; y++) {
        if (data[foundMake][model].indexOf(y) === -1) data[foundMake][model].push(y);
      }
    });
  });

  /* Sort years descending */
  Object.keys(data).forEach(function(mk) {
    Object.keys(data[mk]).forEach(function(md) {
      data[mk][md].sort(function(a,b) { return b - a; });
    });
  });

  return data;
})();

(function initVehicleSelector() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVehicleSelector);
    return;
  }
  var vehicleData = __stehlenVehicleData;

  var overlay = document.getElementById('mvd-overlay');
  var openBtn = document.getElementById('my-vehicle-btn');
  var closeBtn = document.getElementById('mvd-close');
  var textEl = document.getElementById('my-vehicle-text');
  var changeEl = document.getElementById('my-vehicle-change');
  var currentDiv = document.getElementById('mvd-current');
  var currentText = document.getElementById('mvd-current-text');
  var clearBtn = document.getElementById('mvd-clear-btn');
  var yearSel = document.getElementById('mvd-year');
  var makeSel = document.getElementById('mvd-make');
  var modelSel = document.getElementById('mvd-model');
  var goBtn = document.getElementById('mvd-go');

  if (!overlay || !openBtn) return;

  function getAllYears() {
    var s = new Set();
    Object.values(vehicleData).forEach(function(mk){Object.values(mk).forEach(function(ys){ys.forEach(function(y){s.add(y);});});});
    return Array.from(s).sort(function(a,b){return b-a;});
  }

  function getMakes(yr) {
    var r=[];
    Object.entries(vehicleData).forEach(function(e){if(Object.values(e[1]).some(function(ys){return ys.includes(+yr);}))r.push(e[0]);});
    return r.sort();
  }

  function getModels(yr, mk) {
    var r=[];
    if(vehicleData[mk]) Object.entries(vehicleData[mk]).forEach(function(e){if(e[1].includes(+yr))r.push(e[0]);});
    return r.sort();
  }

  // Filter year options to only show years that have products
  var validYears = getAllYears();
  if (validYears.length > 0) {
    var yearHtml = '<option value="">— Select Year —</option>';
    validYears.forEach(function(y) { yearHtml += '<option value="'+y+'">'+y+'</option>'; });
    yearSel.innerHTML = yearHtml;
  }
  console.log('[MVD] Vehicle data:', JSON.stringify(Object.keys(vehicleData)), 'Years:', validYears.length);

  yearSel.addEventListener('change', function() {
    makeSel.innerHTML = '<option value="">— Select Make —</option>';
    modelSel.innerHTML = '<option value="">— Select Model —</option>';
    modelSel.disabled = true; goBtn.dataset.disabled = "true"; goBtn.style.background = "#999"; goBtn.style.cursor = "not-allowed";
    if (this.value) {
      getMakes(this.value).forEach(function(m) { makeSel.innerHTML += '<option value="'+m+'">'+m+'</option>'; });
      makeSel.disabled = false;
    } else { makeSel.disabled = true; }
  });

  makeSel.addEventListener('change', function() {
    modelSel.innerHTML = '<option value="">— Select Model —</option>';
    goBtn.dataset.disabled = "true"; goBtn.style.background = "#999"; goBtn.style.cursor = "not-allowed";
    if (this.value) {
      getModels(yearSel.value, this.value).forEach(function(m) { modelSel.innerHTML += '<option value="'+m+'">'+m+'</option>'; });
      modelSel.disabled = false;
    } else { modelSel.disabled = true; }
  });

  modelSel.addEventListener('change', function() {
    if (this.value) {
      goBtn.dataset.disabled = 'false';
      goBtn.style.background = '#F39C12';
      goBtn.style.cursor = 'pointer';
    } else {
      goBtn.dataset.disabled = 'true';
      goBtn.style.background = '#999';
      goBtn.style.cursor = 'not-allowed';
    }
  });

  goBtn.addEventListener('click', function() {
    var y=yearSel.value, m=makeSel.value, md=modelSel.value;
    if (y && m && md) {
      localStorage.setItem('selectedVehicle', JSON.stringify({year:y,make:m,model:md}));
      textEl.textContent = y+' '+m+' '+md;
      changeEl.style.display = 'inline';
      overlay.classList.remove('mvd-open');
      document.body.style.overflow = '';
      var tc = document.getElementById('toggle-current');
      if (tc) tc.textContent = '('+y+' '+m+' '+md+')';
      window.location.href = '/collections/all?year='+y+'&make='+encodeURIComponent(m)+'&model='+encodeURIComponent(md);
    }
  });

  window.openVehicleModal = openModal;
  function openModal() {
    overlay.classList.add('mvd-open');
    document.body.style.overflow = 'hidden';
    var saved = localStorage.getItem('selectedVehicle');
    if (saved) {
      var v = JSON.parse(saved);
      currentText.textContent = 'Currently: ' + v.year + ' ' + v.make + ' ' + v.model;
      currentDiv.style.display = 'flex';
      // Restore selects
      yearSel.value = v.year;
      yearSel.dispatchEvent(new Event('change'));
      setTimeout(function(){
        makeSel.value = v.make;
        makeSel.dispatchEvent(new Event('change'));
        setTimeout(function(){
          modelSel.value = v.model;
          goBtn.dataset.disabled = "false"; goBtn.style.background = "#F39C12"; goBtn.style.cursor = "pointer";
        }, 50);
      }, 50);
    } else {
      currentDiv.style.display = 'none';
    }
  }

  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', function() { overlay.classList.remove('mvd-open'); document.body.style.overflow = ''; });
  overlay.addEventListener('click', function(e) { if (e.target === overlay) { overlay.classList.remove('mvd-open'); document.body.style.overflow = ''; }});

  clearBtn.addEventListener('click', function() {
    localStorage.removeItem('selectedVehicle');
    textEl.textContent = 'SELECT YOUR VEHICLE';
    changeEl.style.display = 'none';
    currentDiv.style.display = 'none';
    yearSel.value = '';
    makeSel.innerHTML = '<option value="">— Select Make —</option>'; makeSel.disabled = true;
    modelSel.innerHTML = '<option value="">— Select Model —</option>'; modelSel.disabled = true;
    goBtn.dataset.disabled = "true"; goBtn.style.background = "#999"; goBtn.style.cursor = "not-allowed";
    var tc = document.getElementById('toggle-current');
    if (tc) tc.textContent = '';
  });

  // Restore on load
  var saved = localStorage.getItem('selectedVehicle');
  if (saved) {
    try {
      var v = JSON.parse(saved);
      textEl.textContent = v.year + ' ' + v.make + ' ' + v.model;
      changeEl.style.display = 'inline';
    } catch(e) {}
  }
})();
</script>

{% stylesheet %}
  .cart-drawer {
    --cart-drawer-padding: var(--padding-lg) var(--padding-xl);
    --cart-drawer-padding-desktop: var(--padding-xl) var(--padding-2xl);
    --cart-font-size--2xs: var(--font-size--2xs);
    --cart-font-size--xs: var(--font-size--xs);
    --cart-font-size--sm: var(--font-size--sm);
    --cart-font-size--md: var(--font-size--md);
    --cart-font-size--2xl: var(--font-size--2xl);
  }

  .cart-drawer__dialog {
    position: fixed;
    border-radius: 0;
    width: var(--sidebar-width);
    max-width: 95vw;
    height: 100%;
    margin: 0 0 0 auto;
    padding: 0;
    border-left: var(--style-border-drawer);
    box-shadow: var(--shadow-drawer);
    background-color: var(--color-background);
  }

  /* Needed to ensure the drawer is full height */
  .cart-drawer__dialog:modal {
    max-height: 100dvh;
    overflow-y: hidden;
  }

  .cart-drawer__inner {
    height: 100%;
  }

  .cart-drawer__content {
    padding: 0;
    background-color: var(--color-background);
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow-y: auto;
  }

  .cart-drawer__heading {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
  }

  .cart-drawer__close-button {
    margin-right: calc(var(--padding-sm) * -1);
  }

  .cart-drawer--empty .cart-drawer__content {
    text-align: center;
    min-height: auto;
  }

  .cart-drawer--empty .cart-drawer__heading {
    margin-bottom: var(--margin-md);
  }

  .cart-drawer__items .cart-items__table-row {
    padding-bottom: var(--gap-xl);
    border-bottom: var(--style-border-width) solid var(--color-border);
    margin-bottom: var(--gap-xl);
  }

  .cart-drawer__items .cart-items__table-row:has(+ .cart-items__nested-line) {
    border-bottom: none;
    margin-bottom: 0;
  }

  .cart-drawer__items .cart-items__table-row:last-child {
    border-bottom: none;
  }

  .cart-drawer__summary {
    --cart-drawer-summary-padding: var(--padding-lg);

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--gap-2xl);
    padding: var(--cart-drawer-summary-padding);
    margin-top: auto;
    background-color: var(--color-background);
    /* stylelint-disable-next-line color-named */
    mask-image: linear-gradient(to bottom, transparent, black var(--cart-drawer-summary-padding));

    @media screen and (min-width: 750px) {
      --cart-drawer-summary-padding: var(--padding-2xl);
    }
  }

  .cart-drawer__summary .cart__summary-totals:not(:has(.cart__original-total-container:empty)) {
    border-block-start: var(--style-border-width) solid var(--color-border);
    padding-block-start: var(--padding-2xl);
  }

  .cart-drawer__summary .cart-note {
    @media screen and (min-width: 750px) {
      margin-block-start: var(--margin-3xs);
    }
  }

  .cart-drawer__heading--empty {
    display: flex;
    justify-content: center;
  }

  .cart-drawer__items {
    display: flex;
    flex-direction: column;
    padding-inline: var(--cart-drawer-padding);
    overflow-y: auto;

    @media screen and (min-width: 750px) {
      padding-inline: var(--cart-drawer-padding-desktop);
    }
  }

  .cart-drawer__items .cart-items__table-row {
    padding-bottom: var(--gap-xl);
    border-bottom: var(--style-border-width) solid var(--color-border);
    margin-bottom: var(--gap-xl);
  }

  .cart-drawer__items .cart-items__table-row:last-child {
    border-bottom: none;
    padding-block-end: 0;
    margin-block-end: 0;
  }

  .cart-drawer--empty .cart-drawer__inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100dvh;
    margin-top: 0;
  }

  .cart-drawer:not(:has(.cart-form)) .cart-drawer__content {
    justify-content: center;
  }

  .cart-drawer--empty .cart-drawer__header {
    justify-content: right;
    border-bottom: none;
    padding-bottom: 0;
  }

  .cart-drawer--empty .cart-drawer__heading {
    text-align: center;
  }

  .cart-drawer:not(:has(.cart-form)) .cart-items__wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  header-actions {
    display: flex;

    @media screen and (max-width: 749px) {
      justify-self: flex-end;
    }
  }

  .header__column--right header-actions {
    margin-inline-start: calc(var(--gap-md) * -1);
  }

  .header-actions__action {
    --button-color: var(--color-foreground);

    cursor: pointer;
    display: flex;
    justify-content: center;
  }

  .header-actions__action .svg-wrapper {
    height: var(--button-size);
    width: var(--button-size);
  }

  .header-actions__action svg {
    width: var(--icon-size-md);
    height: var(--icon-size-md);
  }

  .header-actions__cart-icon {
    --cart-bubble-size: 20px;
    --cart-bubble-top: 4.5px;
    --cart-bubble-right: 2.5px;

    position: relative;
  }

  .header-actions__cart-icon .cart-bubble {
    position: absolute;
    width: var(--cart-bubble-size, 20px);
    top: var(--cart-bubble-top);
    right: var(--cart-bubble-right);
  }

  .header-actions__cart-icon .cart-bubble__text,
  .cart-drawer__heading .cart-bubble__text {
    font-family: var(--font-paragraph--family);
    font-weight: var(--font-paragraph--weight);
  }

  .header-actions__cart-icon.header-actions__cart-icon--has-cart svg {
    /* Create donut mask where the cart bubble sits */
    mask: radial-gradient(
      calc(var(--cart-bubble-size) + 2px) at calc(100% - var(--cart-bubble-right)) var(--cart-bubble-top),
      transparent 45.45%,
      #fff 45.45%,
      #fff 100%
    );
  }

  .cart-drawer__heading .cart-bubble__background {
    background-color: rgb(var(--color-foreground-rgb) / var(--opacity-10-25));
  }

  .cart-drawer__heading .cart-bubble__text {
    color: var(--color-foreground);
    font-size: var(--font-size--xs);
  }

  .cart-bubble--animating .cart-bubble__background {
    animation: grow var(--animation-speed) var(--animation-easing);
  }

  .cart-bubble--animating .cart-bubble__text {
    animation: cartBubbleSlideIn var(--animation-speed) var(--animation-easing);
  }
{% endstylesheet %}

<!-- Vehicle fitment year filter for search results -->
<script>
(function() {
  /* Check hash param first, then query param */
  var fitYear = null;
  var hashMatch = window.location.hash.match(/year=(\d{4})/);
  if (hashMatch) fitYear = parseInt(hashMatch[1]);
  if (!fitYear) {
    var params = new URLSearchParams(window.location.search);
    if (params.get('year')) fitYear = parseInt(params.get('year'));
  }
  /* Also check localStorage vehicle */
  if (!fitYear) {
    try {
      var sv = JSON.parse(localStorage.getItem('selectedVehicle'));
      if (sv && sv.year && window.location.pathname.includes('/search')) fitYear = parseInt(sv.year);
    } catch(e) {}
  }
  if (!fitYear || !window.location.pathname.includes('/search')) return;
  
  function filterByYear() {
    var items = document.querySelectorAll('.product-grid__item, .product-grid > li, .search-results .grid__item, .search__results .grid__item');
    var hidden = 0;
    items.forEach(function(item) {
      var text = item.textContent;
      var rangeMatch = text.match(/(\d{4})\s*[-–]\s*(\d{4})/);
      var plusMatch = !rangeMatch && text.match(/(\d{4})\+/);
      
      if (rangeMatch) {
        var start = parseInt(rangeMatch[1]);
        var end = parseInt(rangeMatch[2]);
        if (fitYear < start || fitYear > end) {
          item.style.display = 'none';
          hidden++;
        }
      } else if (plusMatch) {
        if (fitYear < parseInt(plusMatch[1])) {
          item.style.display = 'none';
          hidden++;
        }
      }
    });
    console.log('[Fitment] Year '+fitYear+': hidden '+hidden+' of '+items.length+' products');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', filterByYear);
  } else {
    filterByYear();
    setTimeout(filterByYear, 500);
    setTimeout(filterByYear, 1500);
  }
})();
</script>