{%- comment -%}
  Category & Vehicle Navigation Bar
  Fully dynamic — pulls from Shopify collections automatically
  Categories = any non-*-parts collection with products
  Vehicles = any *-parts collection with products
{%- endcomment -%}

{%- assign skip_handles = 'all,frontpage,digital-goods-vat-tax,vehicles-and-parts-example-products' | split: ',' -%}

<style>
  .filter-bar-wrapper {
    position: relative; top: 0; z-index: 40;
    background: var(--color-background, #fff);
    padding: 8px 0;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    margin-bottom: 16px;
  }
  .filter-row {
    display: flex; align-items: center; gap: 8px; padding: 6px 0; position: relative;
  }
  .filter-row__label {
    font-weight: 600; font-size: 12px; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--color-foreground);
    white-space: nowrap; min-width: 70px; flex-shrink: 0;
  }
  .filter-row__scroll {
    display: flex; gap: 8px; overflow-x: auto;
    -webkit-overflow-scrolling: touch; scrollbar-width: none; flex: 1; padding-right: 20px;
  }
  .filter-row__scroll::-webkit-scrollbar { display: none; }
  .filter-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; background: var(--color-background, #fff);
    border: 1.5px solid var(--color-border, #ddd); border-radius: 20px;
    color: var(--color-foreground); text-decoration: none;
    font-weight: 500; font-size: 13px; transition: all 0.15s ease;
    cursor: pointer; font-family: inherit; white-space: nowrap; flex-shrink: 0;
  }
  .filter-btn:hover:not(:disabled) {
    border-color: #F39C12; background: rgba(243,156,18,0.05);
  }
  .filter-btn--active, a.filter-btn--active, button.filter-btn--active {
    background: #F39C12 !important; border-color: #F39C12 !important; color: #fff !important;
  }
  .filter-btn--active:hover, a.filter-btn--active:hover, button.filter-btn--active:hover {
    background: #E67E22 !important; border-color: #E67E22 !important; color: #fff !important;
  }
  .filter-btn:disabled, .filter-btn--disabled {
    opacity: 0.4; cursor: not-allowed; pointer-events: none;
  }
  .filter-btn__icon { width: 16px; height: 16px; color: #F39C12; flex-shrink: 0; }
  .filter-btn--active .filter-btn__icon { color: #fff; }
  .product-grid__item.filter-hidden { display: none !important; }
  @media (max-width: 749px) {
    .filter-row__label { font-size: 11px; min-width: 60px; }
    .filter-btn { font-size: 12px; padding: 5px 10px; }
  }
</style>

<div class="filter-bar-wrapper">
  <!-- Category row -->
  <div class="filter-row">
    <span class="filter-row__label">Shop by:</span>
    <div class="filter-row__scroll">
      <a href="/collections/all" class="filter-btn category-filter-btn" data-handle="all">All</a>
      {%- for collection in collections -%}
        {%- assign is_vehicle = false -%}
        {%- assign is_skip = false -%}
        {%- if collection.handle contains '-parts' -%}{%- assign is_vehicle = true -%}{%- endif -%}
        {%- for sh in skip_handles -%}
          {%- if collection.handle == sh -%}{%- assign is_skip = true -%}{%- endif -%}
        {%- endfor -%}
        {%- unless is_vehicle or is_skip -%}
          {%- if collection.products_count > 0 -%}
            <a href="/collections/{{ collection.handle }}" class="filter-btn category-filter-btn" data-handle="{{ collection.handle }}">
              {%- if collection.handle contains 'bull' or collection.handle contains 'grille' -%}
                <svg class="filter-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L4 6v6c0 5.5 3.5 10 8 12 4.5-2 8-6.5 8-12V6l-8-4z"/><path d="M8 11h8M8 14h8M8 8h8"/></svg>
              {%- elsif collection.handle contains 'side' or collection.handle contains 'nerf' or collection.handle contains 'step' -%}
                <svg class="filter-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="18" width="20" height="4" rx="1"/><rect x="5" y="14" width="14" height="3" rx="1"/><path d="M6 14V10M18 14V10"/></svg>
              {%- elsif collection.handle contains 'tonneau' or collection.handle contains 'cover' -%}
                <svg class="filter-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 14h18v6H3z"/><path d="M5 14V8h14v6"/><path d="M7 11h10M7 8l5-3 5 3"/></svg>
              {%- elsif collection.handle contains 'chase' or collection.handle contains 'rack' or collection.handle contains 'sport-bar' -%}
                <svg class="filter-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 18h16"/><path d="M6 18V8h12v10"/><path d="M6 8l6-4 6 4"/><circle cx="8" cy="5" r="1.5" fill="currentColor"/><circle cx="16" cy="5" r="1.5" fill="currentColor"/></svg>
              {%- elsif collection.handle contains 'hitch' or collection.handle contains 'trailer' -%}
                <svg class="filter-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="15" r="3"/><path d="M12 12V4"/><path d="M5 4h14"/><path d="M5 4v4h14V4"/></svg>
              {%- else -%}
                <svg class="filter-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M3 9h18"/></svg>
              {%- endif -%}
              {{ collection.title }}
            </a>
          {%- endif -%}
        {%- endunless -%}
      {%- endfor -%}
    </div>
  </div>

  <!-- Vehicle row -->
  <div class="filter-row">
    <span class="filter-row__label">Vehicle:</span>
    <div class="filter-row__scroll">
      {%- for collection in collections -%}
        {%- if collection.handle contains '-parts' and collection.products_count > 0 -%}
          {%- assign make_name = collection.title | remove: ' Parts' -%}
          <button type="button" class="filter-btn vehicle-filter-btn" data-make="{{ make_name }}" data-handle="{{ collection.handle }}">
            {{ make_name }}
          </button>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
</div>

{%- comment -%} Build product-to-collection mapping for client-side filtering {%- endcomment -%}
<script type="application/json" id="collection-product-map">
{
  {%- assign first_col = true -%}
  {%- for collection in collections -%}
    {%- if collection.handle contains '-parts' and collection.products_count > 0 -%}
      {%- assign make_name = collection.title | remove: ' Parts' -%}
      {%- unless first_col -%},{%- endunless -%}
      "{{ make_name }}": [
        {%- for product in collection.products -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {{ product.id }}
        {%- endfor -%}
      ]
      {%- assign first_col = false -%}
    {%- endif -%}
  {%- endfor -%}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const categoryButtons = document.querySelectorAll('.category-filter-btn');
  const vehicleButtons = document.querySelectorAll('.vehicle-filter-btn');

  // Load vehicle→product mapping from Liquid-generated JSON
  let vehicleProductMap = {};
  try {
    vehicleProductMap = JSON.parse(document.getElementById('collection-product-map').textContent);
  } catch(e) {}

  // Highlight current category from URL
  const currentHandle = (window.location.pathname.match(/\/collections\/([^\/\?]+)/) || [])[1] || 'all';
  categoryButtons.forEach(btn => {
    btn.classList.toggle('filter-btn--active', btn.dataset.handle === currentHandle);
  });

  // Vehicle filtering — client-side on product grid using the Liquid-injected map
  function getProductItems() {
    return document.querySelectorAll('.product-grid__item, .product-grid > li');
  }

  function getProductId(item) {
    // Try data attributes, then link href
    if (item.dataset.productId) return parseInt(item.dataset.productId);
    const link = item.querySelector('a[href*="/products/"]');
    return link ? link.href : item.textContent;
  }

  function getProductText(item) {
    return (item.textContent + ' ' + (item.dataset.tags || '')).toLowerCase();
  }

  function applyVehicleFilter() {
    const activeMakes = Array.from(document.querySelectorAll('.vehicle-filter-btn.filter-btn--active'))
      .map(b => b.dataset.make);

    if (!activeMakes.length) {
      // Show all
      getProductItems().forEach(item => {
        item.classList.remove('filter-hidden');
        item.style.removeProperty('display');
      });
      return;
    }

    // Build set of matching product IDs
    const matchIds = new Set();
    activeMakes.forEach(make => {
      (vehicleProductMap[make] || []).forEach(id => matchIds.add(id));
    });

    getProductItems().forEach(item => {
      const text = getProductText(item);
      // Check by text matching as fallback (make name in product card text)
      const textMatch = activeMakes.some(make => text.includes(make.toLowerCase()));
      // Also check universal products
      const isUniversal = text.includes('universal');

      if (textMatch || isUniversal) {
        item.classList.remove('filter-hidden');
        item.style.removeProperty('display');
      } else {
        item.classList.add('filter-hidden');
      }
    });
  }

  vehicleButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      if (!this.disabled) {
        this.classList.toggle('filter-btn--active');
        applyVehicleFilter();
      }
    });
  });

  // Category buttons navigate to collection pages (server-side filtering)
  // No JS needed — they're <a> links

  // If vehicle params in URL, restore them
  const params = new URLSearchParams(window.location.search);
  const makes = params.get('makes') ? params.get('makes').split(',') : [];
  makes.forEach(make => {
    const btn = document.querySelector(`.vehicle-filter-btn[data-make="${make}"]`);
    if (btn) btn.classList.add('filter-btn--active');
  });
  if (makes.length) applyVehicleFilter();

  // Update URL when vehicle filter changes
  const origApply = applyVehicleFilter;
  // Already handled inline
});
</script>