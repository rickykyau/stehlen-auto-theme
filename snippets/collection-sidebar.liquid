{%- comment -%}
  Collection Sidebar Filters — Stehlen Auto
  Single product listing page with URL param filters
{%- endcomment -%}

{%- assign skip_handles = 'all,frontpage,digital-goods-vat-tax,vehicles-and-parts-example-products' | split: ',' -%}

<style>
/* ===== SIDEBAR STYLES ===== */
.collection-sidebar {
  width: 260px;
  min-width: 260px;
  flex-shrink: 0;
  position: sticky;
  top: 80px;
  align-self: flex-start;
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  overflow-x: hidden;
  padding-bottom: 40px;
  scrollbar-width: thin;
}
.collection-sidebar::-webkit-scrollbar { width: 5px; }
.collection-sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

/* Filter sections */
.sf-section {
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  margin-bottom: 12px;
  background: #fff;
  overflow: hidden;
}
.sf-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.82rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #1E2326;
  user-select: none;
  background: #fafafa;
  border-bottom: 1px solid #eee;
}
.sf-header:hover { background: #f0f0f0; }
.sf-chevron {
  transition: transform 0.2s;
  font-size: 0.6rem;
  color: #999;
}
.sf-section.collapsed .sf-body { display: none; }
.sf-section.collapsed .sf-chevron { transform: rotate(-90deg); }
.sf-body { padding: 10px 14px 14px; }

/* Subsection labels */
.sf-sublabel {
  font-weight: 600;
  font-size: 0.78rem;
  color: #888;
  margin: 0 0 6px 0;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.sf-hint {
  font-size: 0.78rem;
  color: #aaa;
  font-style: italic;
  padding: 2px 0 6px;
}

/* Search input */
.sf-search {
  width: 100%;
  padding: 7px 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 0.82rem;
  margin-bottom: 8px;
  outline: none;
  box-sizing: border-box;
}
.sf-search:focus { border-color: #F39C12; box-shadow: 0 0 0 2px rgba(243,156,18,0.15); }

/* Checkbox items — NO inner scroll, let sidebar scroll */
.sf-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
.sf-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  font-size: 0.85rem;
  cursor: pointer;
  color: #333;
}
.sf-item:hover { color: #F39C12; }
.sf-item input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: #F39C12;
  cursor: pointer;
  flex-shrink: 0;
  margin: 0;
}
.sf-item label { flex: 1; cursor: pointer; }

/* Mobile */
@media (max-width: 749px) {
  .collection-sidebar {
    width: 100% !important;
    min-width: 100% !important;
    position: relative;
    top: 0;
    max-height: none;
    overflow: visible;
    display: none;
  }
  .collection-sidebar.sb-open {
    display: block;
    margin-bottom: 16px;
  }
}

/* Hidden product items — multiple selectors for certainty */
.product-grid__item.sf-hidden,
li.sf-hidden,
.sf-hidden {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  overflow: hidden !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* Force 3-col grid inside sidebar layout */
.stehlen-collection-main .product-grid {
  grid-template-columns: repeat(3, 1fr) !important;
}
@media (max-width: 749px) {
  .stehlen-collection-main .product-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}
</style>

<!-- Sidebar -->
<aside class="collection-sidebar" id="collection-sidebar">
  
  <!-- Vehicle Fitment -->
  <div class="sf-section" id="sf-fitment">
    <div class="sf-header" data-toggle="sf-fitment">
      Vehicle Fitment
      <span class="sf-chevron">▼</span>
    </div>
    <div class="sf-body">
      <p class="sf-sublabel">Make</p>
      <input type="text" class="sf-search" id="sf-make-search" placeholder="Search makes...">
      <ul class="sf-list" id="sf-make-list">
        {%- for c in collections -%}
          {%- if c.handle contains '-parts' and c.products_count > 0 -%}
            {%- assign mk = c.title | remove: ' Parts' -%}
            <li class="sf-item">
              <input type="checkbox" id="mk-{{ mk | handleize }}" value="{{ mk }}" class="sf-make">
              <label for="mk-{{ mk | handleize }}">{{ mk }}</label>
            </li>
          {%- endif -%}
        {%- endfor -%}
      </ul>

      <p class="sf-sublabel" style="margin-top:12px;">Model</p>
      <div class="sf-hint" id="sf-model-hint">Select a make first</div>
      <ul class="sf-list" id="sf-model-list"></ul>

      <p class="sf-sublabel" style="margin-top:12px;">Year</p>
      <ul class="sf-list" id="sf-year-list">
        {%- for y in (2000..2026) reversed -%}
          <li class="sf-item">
            <input type="checkbox" id="yr-{{ y }}" value="{{ y }}" class="sf-year">
            <label for="yr-{{ y }}">{{ y }}</label>
          </li>
        {%- endfor -%}
      </ul>
    </div>
  </div>

  <!-- Category -->
  <div class="sf-section" id="sf-category">
    <div class="sf-header" data-toggle="sf-category">
      Category
      <span class="sf-chevron">▼</span>
    </div>
    <div class="sf-body">
      <input type="text" class="sf-search" id="sf-cat-search" placeholder="Search categories...">
      <ul class="sf-list" id="sf-cat-list">
        {%- for c in collections -%}
          {%- assign skip = false -%}
          {%- if c.handle contains '-parts' -%}{%- assign skip = true -%}{%- endif -%}
          {%- for sh in skip_handles -%}
            {%- if c.handle == sh -%}{%- assign skip = true -%}{%- endif -%}
          {%- endfor -%}
          {%- unless skip -%}
            {%- if c.products_count > 0 -%}
              <li class="sf-item" data-handle="{{ c.handle }}">
                <input type="checkbox" id="cat-{{ c.handle }}" value="{{ c.handle }}" class="sf-cat">
                <label for="cat-{{ c.handle }}">{{ c.title }}</label>
              </li>
            {%- endif -%}
          {%- endunless -%}
        {%- endfor -%}
      </ul>
    </div>
  </div>
</aside>

{%- comment -%} Product data for client-side filtering {%- endcomment -%}
<script id="sf-product-data" type="application/json">
[
  {%- paginate collections.all.products by 250 -%}
    {%- for p in collections.all.products -%}
      {%- unless forloop.first -%},{%- endunless -%}
      { "id": {{ p.id }}, "title": {{ p.title | json }}, "type": {{ p.type | json }}, "tags": {{ p.tags | json }} }
    {%- endfor -%}
  {%- endpaginate -%}
]
</script>

<script>
(function(){
  /* === CONFIG === */
  var ALIASES = {
    'chevy':['chevy','chevrolet'],'chevrolet':['chevy','chevrolet'],
    'dodge':['dodge','ram'],'ram':['dodge','ram'],
    'mercedes-benz':['mercedes','mercedes-benz','benz'],'mercedes':['mercedes','mercedes-benz','benz'],
    'vw':['vw','volkswagen'],'volkswagen':['vw','volkswagen'],
    'gmc':['gmc','chevy','chevrolet']
  };
  var STOP = ['trailer','hitch','class','bull','guard','grille','side','step','nerf','bar',
    'tonneau','cover','chase','rack','sport','matte','black','stainless','led','light',
    'low','profile','hard','tri-fold','bed','universal','-','w/','&','front','rear'];

  function kws(make){ return ALIASES[make.toLowerCase()] || [make.toLowerCase()]; }
  function yearRange(title){
    var m = title.match(/(\d{4})\s*[-–]\s*(\d{4})/);
    if(m) return [+m[1],+m[2]];
    m = title.match(/(\d{4})\+/);
    if(m) return [+m[1],2026];
    m = title.match(/\b(19|20)\d{2}\b/);
    if(m) return [+m[0],+m[0]];
    return null;
  }

  function init(){
    /* Load product data */
    var dataEl = document.getElementById('sf-product-data');
    var products = [];
    try { products = JSON.parse(dataEl.textContent); } catch(e){ console.error('SF: bad product data',e); }

    /* Build product ID → data map */
    var pMap = {};
    products.forEach(function(p){ pMap[p.id] = p; });

    /* === Collapsible sections === */
    document.querySelectorAll('.sf-header[data-toggle]').forEach(function(h){
      h.addEventListener('click', function(){
        var sec = document.getElementById(h.dataset.toggle);
        if(sec) sec.classList.toggle('collapsed');
      });
    });

    /* === Search inputs === */
    function wireSearch(inputId, listId){
      var inp = document.getElementById(inputId);
      var list = document.getElementById(listId);
      if(!inp || !list) return;
      inp.addEventListener('input', function(){
        var q = this.value.toLowerCase();
        list.querySelectorAll('.sf-item').forEach(function(li){
          li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });
    }
    wireSearch('sf-make-search','sf-make-list');
    wireSearch('sf-cat-search','sf-cat-list');

    /* === Vehicle badge === */
    var saved = localStorage.getItem('selectedVehicle');
    if(saved){
      try{
        var v = JSON.parse(saved);
        if(v.year && v.make && v.model){
          var badge = document.getElementById('topbar-vehicle-badge');
          var txt = document.getElementById('topbar-vehicle-text');
          if(badge && txt){ txt.textContent = v.year+' '+v.make+' '+v.model; badge.style.display='inline-flex'; }
        }
      } catch(e){}
    }

    /* === Mobile toggle === */
    var mobBtn = document.getElementById('mobile-filter-toggle');
    var sb = document.getElementById('collection-sidebar');
    if(mobBtn && sb){ mobBtn.addEventListener('click', function(){ sb.classList.toggle('sb-open'); }); }

    /* === Get all product grid items === */
    function getItems(){
      return document.querySelectorAll('.product-grid__item, ul.product-grid > li');
    }

    function getItemProductId(item){
      /* ID format: "sectionId-productId" */
      var id = item.getAttribute('data-product-id');
      if(id) return +id;
      var rawId = item.id || '';
      var parts = rawId.split('-');
      if(parts.length >= 2) return +parts[parts.length-1];
      return 0;
    }

    /* === MAIN FILTER === */
    function applyAllFilters(){
      var selMakes = []; document.querySelectorAll('.sf-make:checked').forEach(function(c){ selMakes.push(c.value); });
      var selYears = []; document.querySelectorAll('.sf-year:checked').forEach(function(c){ selYears.push(+c.value); });
      var selCats = []; document.querySelectorAll('.sf-cat:checked').forEach(function(c){ selCats.push(c.value); });
      var selModels = []; document.querySelectorAll('.sf-model:checked').forEach(function(c){ selModels.push(c.value.toLowerCase()); });

      var hasFilter = selMakes.length || selYears.length || selCats.length || selModels.length;
      var items = getItems();
      var visible = 0;
      console.log('[SF] Filter:', {makes:selMakes, years:selYears, cats:selCats, models:selModels, items:items.length, hasFilter:hasFilter});

      items.forEach(function(item){
        if(!hasFilter){ item.classList.remove('sf-hidden'); item.style.removeProperty('display'); visible++; return; }

        var pid = getItemProductId(item);
        var pd = pMap[pid];
        var title = pd ? pd.title.toLowerCase() : (item.textContent||'').toLowerCase();
        var ptype = pd ? (pd.type||'').toLowerCase() : '';
        var isUniversal = title.includes('universal');
        var show = true;

        /* Make filter */
        if(selMakes.length && !isUniversal){
          var makeOk = selMakes.some(function(mk){
            return kws(mk).some(function(k){ return title.includes(k); });
          });
          if(!makeOk) show = false;
        }

        /* Year filter */
        if(show && selYears.length && !isUniversal){
          var yr = yearRange(pd ? pd.title : title);
          if(yr){
            var yearOk = selYears.some(function(y){ return y >= yr[0] && y <= yr[1]; });
            if(!yearOk) show = false;
          } else { show = false; }
        }

        /* Model filter */
        if(show && selModels.length && !isUniversal){
          var modelOk = selModels.some(function(m){ return title.includes(m); });
          if(!modelOk) show = false;
        }

        /* Category filter — match product type keywords against handle */
        if(show && selCats.length){
          var catOk = selCats.some(function(handle){
            var words = handle.replace(/-/g,' ').split(' ');
            return words.some(function(w){ return w.length > 2 && (title.includes(w) || ptype.includes(w)); });
          });
          if(!catOk) show = false;
        }

        if(show){ item.classList.remove('sf-hidden'); item.style.removeProperty('display'); visible++; }
        else {
          item.classList.add('sf-hidden');
          item.style.display = 'none';
        }
      });

      /* Count */
      var countEl = document.getElementById('product-count');
      if(countEl){
        countEl.textContent = hasFilter
          ? visible + ' of ' + items.length + ' products'
          : items.length + ' products';
      }

      /* Update models */
      updateModels(selMakes);
    }

    /* === Dynamic model list === */
    function updateModels(selMakes){
      var mList = document.getElementById('sf-model-list');
      var mHint = document.getElementById('sf-model-hint');
      if(!mList) return;

      if(!selMakes.length){
        mList.innerHTML = '';
        if(mHint){ mHint.style.display=''; mHint.textContent='Select a make first'; }
        return;
      }

      var models = {};
      products.forEach(function(p){
        var t = p.title;
        var tl = t.toLowerCase();
        if(tl.includes('universal')) return;
        var makeMatch = selMakes.some(function(mk){ return kws(mk).some(function(k){ return tl.includes(k); }); });
        if(!makeMatch) return;
        /* Extract model: remove year prefix, remove make words, take first 1-2 non-stop words */
        var rest = t.replace(/^\d{4}\s*[-–+]\s*\d{0,4}\s*/,'').trim();
        selMakes.forEach(function(mk){
          kws(mk).forEach(function(k){
            rest = rest.replace(new RegExp('\\b'+k.replace(/[\/\-]/g,'[\\/-]?')+'\\b\\s*','ig'),'');
          });
        });
        var words = rest.trim().split(/\s+/);
        var mw = [];
        for(var i=0; i<words.length && mw.length<2; i++){
          if(STOP.indexOf(words[i].toLowerCase())>=0) break;
          if(/^\d/.test(words[i]) && !mw.length) continue;
          mw.push(words[i]);
        }
        var model = mw.join(' ').replace(/[,\/]$/,'');
        if(model && model.length > 1) models[model] = (models[model]||0)+1;
      });

      var sorted = Object.keys(models).sort();
      if(!sorted.length){
        mList.innerHTML = '';
        if(mHint){ mHint.style.display=''; mHint.textContent='No models found'; }
        return;
      }

      if(mHint) mHint.style.display='none';
      /* Preserve checked state */
      var wasChecked = {};
      mList.querySelectorAll('.sf-model:checked').forEach(function(c){ wasChecked[c.value]=true; });
      mList.innerHTML = '';
      sorted.forEach(function(model){
        var li = document.createElement('li');
        li.className = 'sf-item';
        var id = 'mdl-'+model.replace(/\s+/g,'-').toLowerCase();
        li.innerHTML = '<input type="checkbox" id="'+id+'" value="'+model+'" class="sf-model"'+(wasChecked[model]?' checked':'')+'>'+
          '<label for="'+id+'">'+model+'</label>';
        mList.appendChild(li);
        li.querySelector('input').addEventListener('change', applyAllFilters);
      });
    }

    /* === Wire up checkboxes === */
    document.querySelectorAll('.sf-make,.sf-year,.sf-cat').forEach(function(cb){
      cb.addEventListener('change', applyAllFilters);
    });

    /* === Read URL params and pre-check === */
    var params = new URLSearchParams(window.location.search);
    var pCat = params.get('category');
    var pMake = params.get('make');
    var pYear = params.get('year');
    var pModel = params.get('model');
    var any = false;

    if(pCat){
      document.querySelectorAll('.sf-cat').forEach(function(cb){
        if(cb.value === pCat){ cb.checked=true; any=true; }
      });
    }
    if(pMake){
      document.querySelectorAll('.sf-make').forEach(function(cb){
        if(cb.value.toLowerCase() === pMake.toLowerCase()){ cb.checked=true; any=true; }
      });
    }
    if(pYear){
      document.querySelectorAll('.sf-year').forEach(function(cb){
        if(cb.value === pYear){ cb.checked=true; any=true; }
      });
    }

    /* Apply on load if any filters set */
    if(any){
      setTimeout(function(){
        applyAllFilters();
        if(pModel){
          setTimeout(function(){
            document.querySelectorAll('.sf-model').forEach(function(cb){
              if(cb.value.toLowerCase() === pModel.toLowerCase()) cb.checked = true;
            });
            if(document.querySelector('.sf-model:checked')) applyAllFilters();
          }, 400);
        }
      }, 200);
    }
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>