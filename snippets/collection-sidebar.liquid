{%- comment -%}
  Collection Sidebar Filters
  Left sidebar with checkbox filters for Make, Model, Year, Category
  Armordillo-style design
{%- endcomment -%}

{%- assign skip_handles = 'all,frontpage,digital-goods-vat-tax,vehicles-and-parts-example-products' | split: ',' -%}

<style>
/* ===== SIDEBAR + GRID LAYOUT ===== */
.stehlen-collection-layout {
  display: flex !important;
  gap: 24px !important;
  max-width: var(--page-width, 1200px) !important;
  margin: 0 auto !important;
  padding: 16px !important;
  width: 100% !important;
}
.collection-sidebar {
  width: 240px;
  min-width: 240px;
  flex-shrink: 0;
  position: sticky;
  top: 80px;
  align-self: flex-start;
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  scrollbar-width: thin;
  padding-bottom: 40px;
}
.collection-sidebar::-webkit-scrollbar { width: 4px; }
.collection-sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
.stehlen-collection-main {
  flex: 1 !important;
  min-width: 0 !important;
}
/* Override theme grid inside our layout */
.stehlen-collection-main .collection-wrapper {
  display: block !important;
}
.stehlen-collection-main .collection-wrapper > * {
  grid-column: unset !important;
}

/* Top bar */
.collection-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}
.collection-topbar__title {
  font-size: 1.4rem;
  font-weight: 800;
  text-transform: uppercase;
  color: var(--color-foreground);
  margin: 0;
}
.collection-topbar__count {
  font-size: 0.85rem;
  color: #888;
  margin-top: 2px;
}
.collection-topbar__vehicle-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border: 1.5px solid #F39C12;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--color-foreground);
  background: #fff;
}
.collection-topbar__vehicle-badge svg { color: #F39C12; flex-shrink: 0; }
.collection-topbar__sort select {
  padding: 8px 32px 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.85rem;
  background: #fff;
  color: var(--color-foreground);
  appearance: menulist;
  cursor: pointer;
}

/* Sidebar filter sections */
.sidebar-section {
  border: 1px solid #eee;
  border-radius: 8px;
  margin-bottom: 12px;
  background: #fff;
  overflow: hidden;
}
.sidebar-section__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  color: var(--color-foreground);
  user-select: none;
  background: #fafafa;
  border-bottom: 1px solid #eee;
}
.sidebar-section__header:hover { background: #f5f5f5; }
.sidebar-section__toggle {
  font-size: 0.7rem;
  transition: transform 0.2s;
  color: #999;
}
.sidebar-section[data-collapsed="true"] .sidebar-section__body { display: none; }
.sidebar-section[data-collapsed="true"] .sidebar-section__toggle { transform: rotate(-90deg); }
.sidebar-section__body {
  padding: 10px 14px 14px;
}

/* Search within section */
.sidebar-search {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.8rem;
  margin-bottom: 8px;
  outline: none;
  box-sizing: border-box;
}
.sidebar-search:focus { border-color: #F39C12; }

/* Checkbox list */
.sidebar-checks {
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 200px;
  overflow-y: auto;
  scrollbar-width: thin;
}
.sidebar-checks::-webkit-scrollbar { width: 3px; }
.sidebar-checks::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }
.sidebar-check {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 0.85rem;
  cursor: pointer;
  color: var(--color-foreground);
}
.sidebar-check:hover { color: #F39C12; }
.sidebar-check input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: #F39C12;
  cursor: pointer;
  flex-shrink: 0;
}
.sidebar-check__label { flex: 1; }
.sidebar-check__count {
  font-size: 0.75rem;
  color: #999;
}
.sidebar-sublabel {
  font-size: 0.8rem;
  color: #999;
  font-style: italic;
  padding: 4px 0;
}

/* Mobile: sidebar becomes top drawer */
@media (max-width: 749px) {
  .stehlen-collection-layout {
    flex-direction: column !important;
    gap: 0 !important;
    padding: 8px !important;
  }
  .collection-sidebar {
    width: 100%;
    position: relative;
    top: 0;
    max-height: none;
    overflow: visible;
    display: none; /* hidden by default on mobile */
  }
  .collection-sidebar--open {
    display: block;
    margin-bottom: 16px;
  }
  .collection-topbar__mobile-filter {
    display: inline-flex !important;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: 1.5px solid #ddd;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    background: #fff;
    color: var(--color-foreground);
  }
  .collection-topbar__mobile-filter:hover { border-color: #F39C12; }
}
@media (min-width: 750px) {
  .collection-topbar__mobile-filter { display: none !important; }
}
</style>

<!-- Top bar: Title + Vehicle Badge + Sort -->
<div class="collection-topbar" id="collection-topbar">
  <div>
    <h1 class="collection-topbar__title">{{ collection.title | default: 'All Products' }}</h1>
    <div class="collection-topbar__count" id="product-count">{{ collection.products_count }} products available</div>
  </div>
  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <div class="collection-topbar__vehicle-badge" id="topbar-vehicle-badge" style="display:none;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <span>Shopping for: <strong id="topbar-vehicle-text"></strong></span>
    </div>
    <div class="collection-topbar__mobile-filter" id="mobile-filter-toggle" style="display:none;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M6 12h12M8 18h8"/></svg>
      Filter
    </div>
  </div>
</div>

<!-- Sidebar -->
<aside class="collection-sidebar" id="collection-sidebar">
  
  <!-- Vehicle Fitment -->
  <div class="sidebar-section" id="fitment-section">
    <div class="sidebar-section__header" onclick="this.parentElement.dataset.collapsed=this.parentElement.dataset.collapsed==='true'?'false':'true'">
      Vehicle Fitment
      <span class="sidebar-section__toggle">▼</span>
    </div>
    <div class="sidebar-section__body">
      <!-- Make -->
      <div style="margin-bottom:10px;">
        <div style="font-weight:600;font-size:0.8rem;color:#666;margin-bottom:4px;">Make</div>
        <input type="text" class="sidebar-search" id="make-search" placeholder="Search makes...">
        <ul class="sidebar-checks" id="make-list">
          {%- for collection_item in collections -%}
            {%- if collection_item.handle contains '-parts' and collection_item.products_count > 0 -%}
              {%- assign make_name = collection_item.title | remove: ' Parts' -%}
              <li class="sidebar-check" data-make="{{ make_name }}">
                <input type="checkbox" id="make-{{ make_name | handleize }}" value="{{ make_name }}" class="make-checkbox">
                <label class="sidebar-check__label" for="make-{{ make_name | handleize }}">{{ make_name }}</label>
              </li>
            {%- endif -%}
          {%- endfor -%}
        </ul>
      </div>
      
      <!-- Model -->
      <div style="margin-bottom:10px;">
        <div style="font-weight:600;font-size:0.8rem;color:#666;margin-bottom:4px;">Model</div>
        <div class="sidebar-sublabel" id="model-placeholder">Select a make first</div>
        <ul class="sidebar-checks" id="model-list" style="display:none;"></ul>
      </div>
      
      <!-- Year -->
      <div>
        <div style="font-weight:600;font-size:0.8rem;color:#666;margin-bottom:4px;">Year</div>
        <ul class="sidebar-checks" id="year-list">
          {%- for y in (2000..2026) reversed -%}
            <li class="sidebar-check" data-year="{{ y }}">
              <input type="checkbox" id="year-{{ y }}" value="{{ y }}" class="year-checkbox">
              <label class="sidebar-check__label" for="year-{{ y }}">{{ y }}</label>
            </li>
          {%- endfor -%}
        </ul>
      </div>
    </div>
  </div>

  <!-- Category -->
  <div class="sidebar-section" id="category-section">
    <div class="sidebar-section__header" onclick="this.parentElement.dataset.collapsed=this.parentElement.dataset.collapsed==='true'?'false':'true'">
      Category
      <span class="sidebar-section__toggle">▼</span>
    </div>
    <div class="sidebar-section__body">
      <input type="text" class="sidebar-search" id="category-search" placeholder="Search categories...">
      <ul class="sidebar-checks" id="category-list">
        {%- for collection_item in collections -%}
          {%- assign dominated = false -%}
          {%- if collection_item.handle contains '-parts' -%}{%- assign dominated = true -%}{%- endif -%}
          {%- for sh in skip_handles -%}
            {%- if collection_item.handle == sh -%}{%- assign dominated = true -%}{%- endif -%}
          {%- endfor -%}
          {%- unless dominated -%}
            {%- if collection_item.products_count > 0 -%}
              <li class="sidebar-check" data-category="{{ collection_item.handle }}">
                <input type="checkbox" id="cat-{{ collection_item.handle }}" value="{{ collection_item.handle }}" class="category-checkbox" data-url="/collections/{{ collection_item.handle }}">
                <label class="sidebar-check__label" for="cat-{{ collection_item.handle }}">{{ collection_item.title }}</label>
              </li>
            {%- endif -%}
          {%- endunless -%}
        {%- endfor -%}
      </ul>
    </div>
  </div>
</aside>

<script>
(function() {
  function initSidebar() {
    /* === Vehicle badge === */
    var saved = localStorage.getItem('selectedVehicle');
    if (saved) {
      try {
        var v = JSON.parse(saved);
        if (v.year && v.make && v.model) {
          var badge = document.getElementById('topbar-vehicle-badge');
          var badgeText = document.getElementById('topbar-vehicle-text');
          if (badge && badgeText) {
            badgeText.textContent = v.year + ' ' + v.make + ' ' + v.model;
            badge.style.display = 'inline-flex';
          }
        }
      } catch(e) {}
    }

    /* === Mobile filter toggle === */
    var mobileToggle = document.getElementById('mobile-filter-toggle');
    var sidebar = document.getElementById('collection-sidebar');
    if (mobileToggle && sidebar) {
      mobileToggle.addEventListener('click', function() {
        sidebar.classList.toggle('collection-sidebar--open');
      });
    }

    /* === Search filters === */
    function setupSearch(inputId, listId) {
      var input = document.getElementById(inputId);
      var list = document.getElementById(listId);
      if (!input || !list) return;
      input.addEventListener('input', function() {
        var q = this.value.toLowerCase();
        list.querySelectorAll('.sidebar-check').forEach(function(li) {
          li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });
    }
    setupSearch('make-search', 'make-list');
    setupSearch('category-search', 'category-list');

    /* === Make/Model/Year keyword maps === */
    var makeAliases = {
      'chevy': ['chevy','chevrolet'],
      'chevrolet': ['chevy','chevrolet'],
      'dodge': ['dodge','ram'],
      'ram': ['dodge','ram'],
      'mercedes-benz': ['mercedes','mercedes-benz','benz'],
      'mercedes': ['mercedes','mercedes-benz','benz'],
      'vw': ['vw','volkswagen'],
      'volkswagen': ['vw','volkswagen']
    };

    function getMakeKeywords(make) {
      var ml = make.toLowerCase();
      return makeAliases[ml] || [ml];
    }

    function getProductText(item) {
      return (item.textContent || '').toLowerCase();
    }

    function getProductYearRange(text) {
      var m = text.match(/(\d{4})\s*[-–]\s*(\d{4})/);
      if (m) return { start: parseInt(m[1]), end: parseInt(m[2]) };
      var mp = text.match(/(\d{4})\+/);
      if (mp) return { start: parseInt(mp[1]), end: 2026 };
      return null;
    }

    function getProductItems() {
      return document.querySelectorAll('.product-grid__item, .product-grid > li');
    }

    /* === Apply all filters === */
    function applyFilters() {
      var selectedMakes = Array.from(document.querySelectorAll('.make-checkbox:checked')).map(function(cb) { return cb.value; });
      var selectedYears = Array.from(document.querySelectorAll('.year-checkbox:checked')).map(function(cb) { return parseInt(cb.value); });
      var selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked')).map(function(cb) { return cb.value; });

      var items = getProductItems();
      var visibleCount = 0;

      items.forEach(function(item) {
        var text = getProductText(item);
        var show = true;

        /* Make filter */
        if (selectedMakes.length > 0) {
          var makeMatch = text.includes('universal') || selectedMakes.some(function(make) {
            return getMakeKeywords(make).some(function(kw) { return text.includes(kw.toLowerCase()); });
          });
          if (!makeMatch) show = false;
        }

        /* Year filter */
        if (show && selectedYears.length > 0) {
          var range = getProductYearRange(text);
          if (range) {
            var yearMatch = selectedYears.some(function(y) { return y >= range.start && y <= range.end; });
            if (!yearMatch) show = false;
          } else if (text.includes('universal')) {
            /* Universal products always show */
          } else {
            show = false;
          }
        }

        /* Category filter - uses collection handles, match by keywords from handle */
        if (show && selectedCategories.length > 0) {
          var catMatch = selectedCategories.some(function(handle) {
            var keywords = handle.replace(/-/g, ' ').split(' ');
            return keywords.some(function(kw) { return kw.length > 2 && text.includes(kw); });
          });
          if (!catMatch) show = false;
        }

        if (show) {
          item.classList.remove('filter-hidden');
          item.style.removeProperty('display');
          visibleCount++;
        } else {
          item.classList.add('filter-hidden');
        }
      });

      /* Update count */
      var countEl = document.getElementById('product-count');
      if (countEl) {
        var total = items.length;
        if (selectedMakes.length || selectedYears.length || selectedCategories.length) {
          countEl.textContent = visibleCount + ' of ' + total + ' products';
        } else {
          countEl.textContent = total + ' products available';
        }
      }

      /* Update models based on selected makes */
      updateModels(selectedMakes);
    }

    /* === Dynamic model list === */
    function updateModels(selectedMakes) {
      var modelList = document.getElementById('model-list');
      var modelPlaceholder = document.getElementById('model-placeholder');
      if (!modelList || !modelPlaceholder) return;

      if (selectedMakes.length === 0) {
        modelList.style.display = 'none';
        modelPlaceholder.style.display = 'block';
        modelPlaceholder.textContent = 'Select a make first';
        return;
      }

      /* Extract models from visible product titles */
      var models = new Set();
      var items = getProductItems();
      items.forEach(function(item) {
        if (item.classList.contains('filter-hidden')) return;
        var text = item.textContent;
        /* Try to extract model from title patterns like "2003-2009 Toyota 4Runner ..." */
        var titleEl = item.querySelector('.product-card__title, .card__heading, h3, a[href*="/products/"]');
        if (!titleEl) return;
        var title = titleEl.textContent.trim();
        /* Remove year prefix */
        var rest = title.replace(/^\d{4}\s*[-–+]\s*\d{0,4}\s*/, '').trim();
        /* Remove make */
        selectedMakes.forEach(function(make) {
          getMakeKeywords(make).forEach(function(kw) {
            var re = new RegExp('\\b' + kw.replace(/[-\/]/g, '[-\\/]?') + '\\b\\s*', 'i');
            rest = rest.replace(re, '');
          });
        });
        /* Model = first 1-2 words */
        var words = rest.trim().split(/\s+/);
        var stopWords = ['trailer','hitch','class','bull','guard','grille','side','step','nerf',
          'bar','tonneau','cover','chase','rack','sport','matte','black','stainless','led',
          'light','low','profile','hard','tri-fold','bed','universal','-','w/','&','front'];
        var modelWords = [];
        for (var i = 0; i < words.length && modelWords.length < 2; i++) {
          if (stopWords.indexOf(words[i].toLowerCase()) >= 0) break;
          if (/^\d/.test(words[i]) && modelWords.length === 0) continue;
          modelWords.push(words[i]);
        }
        var model = modelWords.join(' ').replace(/[,\/]$/, '');
        if (model && model.length > 1) models.add(model);
      });

      if (models.size === 0) {
        modelList.style.display = 'none';
        modelPlaceholder.style.display = 'block';
        modelPlaceholder.textContent = 'No models found';
        return;
      }

      modelPlaceholder.style.display = 'none';
      modelList.style.display = '';
      modelList.innerHTML = '';
      Array.from(models).sort().forEach(function(model) {
        var li = document.createElement('li');
        li.className = 'sidebar-check';
        li.innerHTML = '<input type="checkbox" class="model-checkbox" value="' + model + '" id="model-' + model.replace(/\s+/g,'-').toLowerCase() + '"><label class="sidebar-check__label" for="model-' + model.replace(/\s+/g,'-').toLowerCase() + '">' + model + '</label>';
        modelList.appendChild(li);
        li.querySelector('input').addEventListener('change', applyModelFilter);
      });
    }

    function applyModelFilter() {
      var selectedModels = Array.from(document.querySelectorAll('.model-checkbox:checked')).map(function(cb) { return cb.value.toLowerCase(); });
      if (selectedModels.length === 0) { applyFilters(); return; }

      var items = getProductItems();
      items.forEach(function(item) {
        if (item.classList.contains('filter-hidden')) return;
        var text = getProductText(item);
        var modelMatch = selectedModels.some(function(m) { return text.includes(m); });
        if (!modelMatch && !text.includes('universal')) {
          item.classList.add('filter-hidden');
        }
      });

      /* Update count */
      var countEl = document.getElementById('product-count');
      if (countEl) {
        var total = items.length;
        var visible = Array.from(items).filter(function(i) { return !i.classList.contains('filter-hidden'); }).length;
        countEl.textContent = visible + ' of ' + total + ' products';
      }
    }

    /* === Event listeners === */
    document.querySelectorAll('.make-checkbox, .year-checkbox, .category-checkbox').forEach(function(cb) {
      cb.addEventListener('change', applyFilters);
    });

    /* === Auto-select from URL === */
    var currentHandle = (window.location.pathname.match(/\/collections\/([^\/\?]+)/) || [])[1];
    if (currentHandle && currentHandle !== 'all') {
      /* Check if it's a make collection */
      var makeCheckbox = document.querySelector('.make-checkbox[value]');
      document.querySelectorAll('.make-checkbox').forEach(function(cb) {
        var handle = cb.value.toLowerCase().replace(/\s+/g, '-') + '-parts';
        if (handle === currentHandle || currentHandle.includes(cb.value.toLowerCase())) {
          cb.checked = true;
        }
      });
      /* Check if it's a category */
      document.querySelectorAll('.category-checkbox').forEach(function(cb) {
        if (cb.getAttribute('data-url') === '/collections/' + currentHandle) {
          cb.checked = true;
        }
      });
      /* Apply initial filters */
      var anyChecked = document.querySelector('.make-checkbox:checked, .year-checkbox:checked, .category-checkbox:checked');
      if (anyChecked) setTimeout(applyFilters, 300);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebar);
  } else {
    initSidebar();
  }
})();
</script>